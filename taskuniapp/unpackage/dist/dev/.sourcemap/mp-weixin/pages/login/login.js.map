{"version":3,"file":"login.js","sources":["pages/login/login.vue","pages/login/login.vue?type=page"],"sourcesContent":["<template>\n    <view class=\"login-container\">\n        <view class=\"login-content\">\n            <image class=\"logo\" src=\"/static/logo.webp\" mode=\"aspectFit\"></image>\n            <text class=\"title\">任务打卡</text>\n            <text class=\"subtitle\">坚持每一天，成就更好的自己</text>\n\n            <button class=\"login-btn\" type=\"primary\" @click=\"handleLogin\" :loading=\"loading\">\n                微信一键登录\n            </button>\n\n            <button class=\"skip-btn\" @click=\"skipLogin\">\n                跳过，以游客身份浏览\n            </button>\n\n            <!-- 开发环境：测试登录按钮 -->\n            <!-- <button class=\"test-login-btn\" @click=\"handleTestLogin\" :loading=\"testLoading\">\n                测试登录（开发用）\n            </button> -->\n        </view>\n    </view>\n</template>\n\n<script>\nimport { wechatLogin, testLogin, updateUserInfo } from '@/api/auth';\n\nexport default {\n    data() {\n        return {\n            loading: false,\n            testLoading: false\n        };\n    },\n    methods: {\n        // 测试登录（开发环境使用）\n        async handleTestLogin() {\n            this.testLoading = true;\n\n            try {\n                const res = await testLogin();\n\n                if (res.code === 200) {\n                    // 保存token\n                    uni.setStorageSync('token', res.data.token);\n                    uni.setStorageSync('userId', res.data.userId);\n                    // 清除游客模式标识\n                    uni.removeStorageSync('isGuestMode');\n\n                    uni.showToast({\n                        title: '登录成功',\n                        icon: 'success'\n                    });\n\n                    // 根据是否是新用户决定跳转\n                    setTimeout(() => {\n                        if (res.data.isNewUser) {\n                            // 新用户，跳转到个人信息编辑页\n                            uni.navigateTo({\n                                url: '/pages/profile-edit?fromLogin=true'\n                            });\n                        } else {\n                            // 老用户，直接跳转到首页\n                            uni.switchTab({\n                                url: '/pages/index/index'\n                            });\n                        }\n                    }, 1000);\n                }\n            } catch (error) {\n                console.error('测试登录失败:', error);\n                uni.showToast({\n                    title: '登录失败，请检查后端服务',\n                    icon: 'none',\n                    duration: 2000\n                });\n            } finally {\n                this.testLoading = false;\n            }\n        },\n\n        async handleLogin() {\n            this.loading = true;\n\n            try {\n                // 第一步：获取微信登录code\n                uni.login({\n                    provider: 'weixin',\n                    success: async (loginRes) => {\n                        if (!loginRes.code) {\n                            uni.showToast({\n                                title: '获取登录code失败',\n                                icon: 'none'\n                            });\n                            this.loading = false;\n                            return;\n                        }\n\n                        try {\n                            // 第二步：调用后端登录接口\n                            const res = await wechatLogin(loginRes.code);\n\n                            if (res.code === 200) {\n                                // 保存token\n                                uni.setStorageSync('token', res.data.token);\n                                uni.setStorageSync('userId', res.data.userId);\n                                // 清除游客模式标识\n                                uni.removeStorageSync('isGuestMode');\n\n                                uni.showToast({\n                                    title: '登录成功',\n                                    icon: 'success'\n                                });\n\n                                // 根据是否是新用户决定跳转\n                                setTimeout(() => {\n                                    if (res.data.isNewUser) {\n                                        // 新用户，跳转到个人信息编辑页\n                                        uni.navigateTo({\n                                            url: '/pages/profile-edit?fromLogin=true'\n                                        });\n                                    } else {\n                                        // 老用户，直接跳转到首页\n                                        uni.switchTab({\n                                            url: '/pages/index/index'\n                                        });\n                                    }\n                                }, 1000);\n                            }\n                        } catch (error) {\n                            console.error('后端登录失败:', error);\n                            uni.showToast({\n                                title: error.message || '登录失败',\n                                icon: 'none'\n                            });\n                        } finally {\n                            this.loading = false;\n                        }\n                    },\n                    fail: (error) => {\n                        console.error('微信登录失败:', error);\n                        uni.showToast({\n                            title: '微信登录失败',\n                            icon: 'none'\n                        });\n                        this.loading = false;\n                    }\n                });\n            } catch (error) {\n                console.error('登录错误:', error);\n                uni.showToast({\n                    title: '登录失败',\n                    icon: 'none'\n                });\n                this.loading = false;\n            }\n        },\n\n        // 获取用户信息并更新到服务器\n        async getUserInfoAndUpdate() {\n            return new Promise((resolve) => {\n                uni.getUserProfile({\n                    desc: '用于完善用户资料',\n                    success: async (userInfoRes) => {\n                        console.log('获取到用户信息:', userInfoRes.userInfo);\n\n                        try {\n                            const { nickName, avatarUrl } = userInfoRes.userInfo;\n\n                            // 更新到服务器\n                            await updateUserInfo({\n                                nickname: nickName,\n                                avatarUrl: avatarUrl\n                            });\n\n                            console.log('用户信息已更新到服务器');\n                            resolve();\n                        } catch (error) {\n                            console.error('更新用户信息失败:', error);\n                            resolve(); // 即使失败也继续登录流程\n                        }\n                    },\n                    fail: (error) => {\n                        console.log('用户拒绝授权或获取失败:', error);\n                        resolve(); // 用户拒绝也继续登录流程\n                    }\n                });\n            });\n        },\n\n        // 跳过登录，以游客身份浏览\n        skipLogin() {\n            uni.setStorageSync('isGuestMode', true);\n            uni.switchTab({\n                url: '/pages/index/index'\n            });\n        }\n    }\n};\n</script>\n\n<style scoped>\n.login-container {\n    width: 100%;\n    height: 100vh;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.login-content {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: 60rpx;\n}\n\n.logo {\n    width: 200rpx;\n    height: 200rpx;\n    margin-bottom: 40rpx;\n}\n\n.title {\n    font-size: 48rpx;\n    font-weight: bold;\n    color: #FFFFFF;\n    margin-bottom: 20rpx;\n}\n\n.subtitle {\n    font-size: 28rpx;\n    color: rgba(255, 255, 255, 0.8);\n    margin-bottom: 100rpx;\n}\n\n.login-btn {\n    width: 500rpx;\n    height: 88rpx;\n    background: #FFFFFF;\n    color: #667eea;\n    border-radius: 44rpx;\n    font-size: 32rpx;\n    font-weight: bold;\n    border: none;\n    margin-bottom: 20rpx;\n}\n\n.test-login-btn {\n    width: 500rpx;\n    height: 88rpx;\n    background: rgba(255, 255, 255, 0.3);\n    color: #FFFFFF;\n    border-radius: 44rpx;\n    font-size: 28rpx;\n    border: 2rpx solid #FFFFFF;\n}\n\n.skip-btn {\n    width: 500rpx;\n    height: 88rpx;\n    background: transparent;\n    color: rgba(255, 255, 255, 0.8);\n    border-radius: 44rpx;\n    font-size: 28rpx;\n    border: none;\n    margin-top: 20rpx;\n}\n</style>\n","import MiniProgramPage from '/Users/sunyizhong/uni-app/HBuilderProjects/taskuniapp/pages/login/login.vue'\nwx.createPage(MiniProgramPage)"],"names":["testLogin","uni","wechatLogin","updateUserInfo"],"mappings":"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"}