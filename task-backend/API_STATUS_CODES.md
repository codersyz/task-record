# API 状态码规范

## HTTP 状态码

### 2xx 成功

- **200 OK**: 请求成功（包括业务成功和业务失败）

### 4xx 客户端错误

- **400 Bad Request**: 请求参数格式错误、缺少必需参数
- **401 Unauthorized**: 未认证或 token 无效/过期
- **403 Forbidden**: 无权限访问
- **404 Not Found**: 资源不存在

### 5xx 服务器错误

- **500 Internal Server Error**: 服务器内部错误

## 业务状态码（code 字段）

所有响应都包含一个 `code` 字段表示业务状态：

### 成功状态

- **200**: 操作成功

### 业务错误状态（1xxx）

- **1001**: 今天已经打卡过了
- **1002**: 任务已完成，无法操作
- **1003**: 超出目标天数限制

### 客户端错误（4xx）

- **400**: 请求参数错误
- **401**: 未认证
- **404**: 资源不存在

### 服务器错误（5xx）

- **500**: 服务器内部错误

## 响应格式

### 成功响应

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    // 返回数据
  }
}
```

### 业务失败响应（HTTP 200）

```json
{
  "code": 1001,
  "message": "今天已经打卡过了",
  "data": {
    "checkinDate": "2024-02-11",
    "checkinId": 1
  }
}
```

### 错误响应（HTTP 4xx/5xx）

```json
{
  "code": 404,
  "message": "任务不存在"
}
```

## 设计原则

1. **HTTP 状态码表示传输层状态**
   - 200: 请求成功到达并被处理
   - 4xx: 客户端请求有问题
   - 5xx: 服务器处理出错

2. **业务状态码表示业务层状态**
   - 200: 业务操作成功
   - 1xxx: 业务规则限制（不是错误，是正常的业务逻辑）
   - 4xx/5xx: 真正的错误

3. **业务规则限制使用 HTTP 200 + 业务状态码**
   - "今天已打卡" 不是错误，是业务规则
   - "余额不足" 不是错误，是业务规则
   - "库存不足" 不是错误，是业务规则

4. **真正的错误使用对应的 HTTP 状态码**
   - 参数格式错误 → 400
   - 未登录 → 401
   - 资源不存在 → 404
   - 服务器崩溃 → 500

## 前端处理示例

```javascript
try {
  const res = await api.checkin(data);

  if (res.code === 200) {
    // 业务成功
    showSuccess("打卡成功");
  } else if (res.code === 1001) {
    // 业务规则限制
    showInfo("今天已经打卡过了");
  } else {
    // 其他业务错误
    showError(res.message);
  }
} catch (error) {
  // 网络错误或服务器错误
  showError("请求失败，请重试");
}
```

## 常见场景

### 场景 1: 重复打卡

- HTTP: 200
- Code: 1001
- Message: "今天已经打卡过了"
- 原因: 这是正常的业务规则，不是错误

### 场景 2: 任务不存在

- HTTP: 404
- Code: 404
- Message: "任务不存在"
- 原因: 资源确实不存在

### 场景 3: 参数缺失

- HTTP: 400
- Code: 400
- Message: "任务标题不能为空"
- 原因: 客户端请求格式错误

### 场景 4: Token 过期

- HTTP: 401
- Code: 401
- Message: "token无效或已过期"
- 原因: 需要重新登录

### 场景 5: 数据库错误

- HTTP: 500
- Code: 500
- Message: "服务器错误"
- 原因: 服务器内部错误

## 修改记录

- 2024-02-11: 将"今天已打卡"从 HTTP 400 改为 HTTP 200 + Code 1001
- 原因: 这是业务规则限制，不是请求错误
